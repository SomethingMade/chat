<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NeuFela Watch Party Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 text-black">

<!-- Top Bar -->
<div class="flex justify-between items-center bg-white shadow p-4 sticky top-0 z-50">
  <button id="menuBtn" class="text-xl font-bold">☰</button>
  <h1 class="text-lg sm:text-xl font-bold">NeuFela Watch Party</h1>
</div>

<!-- Sidebar Drawer -->
<div id="drawer" class="fixed top-0 left-0 w-72 h-full bg-white shadow-lg z-50 transform -translate-x-full transition-transform duration-300 overflow-y-auto">
  <div class="p-4 text-lg font-semibold border-b">Online Users</div>
  <div id="userList" class="p-4 space-y-2"></div>
</div>

<!-- Overlay for closing drawer -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden"></div>

<!-- Main Chat Area -->
<div class="max-w-2xl mx-auto p-4 sm:p-6">
  <div id="messages" class="bg-white rounded-lg p-3 h-[70vh] overflow-y-auto shadow mb-4 space-y-2"></div>
  <form id="messageForm" class="flex gap-2">
    <input id="messageInput" type="text" placeholder="Type your message…" class="flex-1 px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring focus:border-black text-sm">
    <button type="submit" class="bg-black text-white px-4 py-2 rounded-full hover:opacity-90 text-sm">Send</button>
  </form>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878.firebaseio.com",
    projectId: "fire-b-a8878",
    storageBucket: "fire-b-a8878.firebasestorage.app",
    messagingSenderId: "658673187627",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  let currentChatRoom = "public";

  const drawer = document.getElementById("drawer");
  const overlay = document.getElementById("overlay");
  const menuBtn = document.getElementById("menuBtn");

  // Drawer toggle
  menuBtn.onclick = () => {
    drawer.classList.toggle("-translate-x-full");
    overlay.classList.toggle("hidden");
  };

  overlay.onclick = () => {
    drawer.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
  };

  // Close drawer when clicking outside
  document.addEventListener("click", e => {
    if (!drawer.contains(e.target) && !menuBtn.contains(e.target)) {
      drawer.classList.add("-translate-x-full");
      overlay.classList.add("hidden");
    }
  });

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    currentUser = user;
    const userRef = db.ref(`users/${user.uid}`);
    userRef.set({
      name: user.displayName || "User",
      avatar: user.photoURL || `https://i.pravatar.cc/150?u=${user.uid}`
    });

    db.ref(`presence/${user.uid}`).set("online");
    window.addEventListener("beforeunload", () => {
      db.ref(`presence/${user.uid}`).set("offline");
    });

    listenForMessages();
    loadOnlineUsers();
  });

  function listenForMessages() {
    const msgRef = db.ref(`chats/${currentChatRoom}`);
    msgRef.off();
    msgRef.on("child_added", snapshot => displayMessage(snapshot.val()));
  }

  function displayMessage(msg) {
    const messagesDiv = document.getElementById("messages");
    const isMe = msg.uid === currentUser.uid;
    const bubble = document.createElement("div");

    bubble.className = `flex items-start ${isMe ? 'justify-end' : 'justify-start'}`;
    bubble.innerHTML = `
      <div class="max-w-[80%] ${isMe ? 'bg-black text-white' : 'bg-gray-200 text-gray-900'} p-3 rounded-2xl shadow relative">
        <div class="text-sm font-medium">${msg.name}</div>
        <div class="text-sm">${msg.text}</div>
        <div class="text-xs absolute bottom-1 right-2 text-gray-300">${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
      </div>
    `;
    messagesDiv.appendChild(bubble);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  document.getElementById("messageForm").addEventListener("submit", e => {
    e.preventDefault();
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (!text) return;

    const message = {
      uid: currentUser.uid,
      name: currentUser.displayName || "User",
      text,
      timestamp: Date.now()
    };

    db.ref(`chats/${currentChatRoom}`).push(message);
    db.ref(`lastMessages/${currentUser.uid}`).set({
      text,
      timestamp: message.timestamp
    });

    input.value = "";
  });

  function loadOnlineUsers() {
    const userList = document.getElementById("userList");

    db.ref("presence").on("value", snap => {
      userList.innerHTML = "";
      snap.forEach(child => {
        const uid = child.key;
        const status = child.val();

        if (uid !== currentUser.uid && status === "online") {
          db.ref("users/" + uid).once("value", userSnap => {
            const user = userSnap.val();
            db.ref("lastMessages/" + uid).once("value", lastSnap => {
              const last = lastSnap.val() || {};

              const card = document.createElement("div");
              card.className = "bg-white rounded-xl p-3 shadow flex gap-3 items-start cursor-pointer hover:bg-gray-100";
              card.onclick = () => {
                openChatWithUser(uid, user);
                drawer.classList.add("-translate-x-full");
                overlay.classList.add("hidden");
              };

              card.innerHTML = `
                <img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover" />
                <div class="flex-1 min-w-0">
                  <div class="font-semibold truncate">${user.name}</div>
                  <div class="text-sm text-gray-600 truncate">${last.text || "No messages yet"}</div>
                </div>
                <div class="text-xs text-gray-400 self-start whitespace-nowrap">
                  ${last.timestamp ? new Date(last.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ""}
                </div>
              `;
              userList.appendChild(card);
            });
          });
        }
      });
    });
  }

  function openChatWithUser(uid, user) {
    currentChatRoom = [currentUser.uid, uid].sort().join("_");
    document.getElementById("messages").innerHTML = "";
    listenForMessages();
  }
</script>
</body>
</html>
