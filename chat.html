<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loopa</title>

  <!-- Tailwind & Firebase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>
</head>
<body class="bg-gray-100 text-black">

<!-- 🔝 Header --------------------------------------------------------------->
<div class="flex justify-between items-center bg-white shadow p-4 sticky top-0 z-50">
  <button id="menuBtn" class="text-xl font-bold">☰</button>

  <div class="relative">
    <h1 class="text-lg sm:text-xl font-bold">Chats</h1>
    <!-- Global unread badge (hidden when total == 0) -->
    <span id="globalUnread"
          class="absolute -top-2 -right-3 hidden bg-red-600 text-white
                 text-[11px] min-w-[20px] px-1 py-0.5 rounded-full text-center"></span>
  </div>
</div>

<!-- 📋 Drawer (friends list) --------------------------------------------->
<div id="drawer"
     class="fixed top-0 left-0 w-72 h-full bg-white shadow-lg z-50
            transform -translate-x-full transition-transform duration-300 overflow-y-auto">

  <div class="p-4 text-lg font-semibold border-b">Online Users</div>

  <div class="p-3 border-b flex justify-end">
    <button onclick="window.location.href='search.html'" title="Search">
      <svg xmlns="http://www.w3.org/2000/svg"
           class="h-6 w-6 text-gray-700 hover:text-black" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1010.5 18.5a7.5 7.5 0 006.15-3.85z" />
      </svg>
    </button>
  </div>

  <div id="userList" class="p-4 space-y-2"></div>
</div>

<!-- Overlay for closing drawer -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden"></div>

<!-- 💬 Main chat area ------------------------------------------------------>
<div class="max-w-2xl mx-auto p-4 sm:p-6">

  <div id="messages"
       class="bg-white rounded-lg p-3 h-[70vh] overflow-y-auto shadow mb-4 space-y-2"></div>

  <!-- 📞 Call buttons -->
  <div id="callButtons" class="flex gap-6 mb-4 justify-center">
    <!-- Video -->
    <button id="videoCallBtn"
            class="bg-black hover:bg-gray-800 text-white px-5 py-3 rounded-full flex items-center gap-3 shadow-md">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
           viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14" />
        <rect x="3" y="7" width="12" height="10" rx="2" ry="2"
              stroke-linejoin="round" />
      </svg>
    </button>
    <!-- Voice -->
    <button id="voiceCallBtn"
            class="bg-black hover:bg-gray-800 text-white px-5 py-3 rounded-full flex items-center gap-3 shadow-md">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
           viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.5 4.5a1 1 0 01-.217 1.09l-2.2 2.2a11.042 11.042 0 005.516 5.516l2.2-2.2a1 1 0 011.09-.217l4.5 1.5a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
      </svg>
    </button>
  </div>

  <!-- ✏️ Send message form -->
  <form id="messageForm" class="flex gap-2">
    <div class="relative flex items-center p-2 bg-white rounded-full shadow-md w-full max-w-md">
      <!-- Emoji picker trigger -->
      <button type="button" id="emojiButton"
              class="absolute left-3 text-gray-500 hover:text-black focus:outline-none"
              aria-label="Emoji picker">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <circle cx="12" cy="12" r="10" />
          <path d="M8 14s1.5 2 4 2 4-2 4-2" />
          <line x1="9" y1="9" x2="9.01" y2="9" />
          <line x1="15" y1="9" x2="15.01" y2="9" />
        </svg>
      </button>

      <input id="messageInput" type="text" placeholder="Type your message…"
             class="flex-1 pl-10 py-2 rounded-full border border-gray-200
                    focus:outline-none text-sm" />

      <button id="sendButton" type="submit"
              class="bg-black text-white p-2 rounded-full hover:bg-gray-800
                     flex items-center justify-center ml-2">
        <svg xmlns="http://www.w3.org/2000/svg"
             class="h-5 w-5 transform rotate-45" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 12h14M12 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </form>

  <!-- 📹 Video-call overlay -->
  <div id="callContainer"
       class="fixed inset-0 bg-black bg-opacity-90 flex flex-col items-center
              justify-center hidden z-50">
    <video id="localVideo"  autoplay muted playsinline class="w-1/2 rounded-lg mb-4"></video>
    <video id="remoteVideo" autoplay        playsinline class="w-1/2 rounded-lg"></video>
    <button id="endCallBtn"
            class="mt-4 px-6 py-2 bg-red-600 text-white rounded-full">End Call</button>
  </div>
</div>

<!-- ************************************************************************** -->
<script>
/* ---------------- Firebase setup ------------------------------------------ */
const firebaseConfig = {
  apiKey:            "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain:        "fire-b-a8878.firebaseapp.com",
  databaseURL:       "https://fire-b-a8878.firebaseio.com",
  projectId:         "fire-b-a8878",
  storageBucket:     "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId:             "1:658673187627:web:6e4c29af661785f0afa36e"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

/* ---------------- Globals -------------------------------------------------- */
let currentUser      = null;
let currentChatRoom  = "public";
const unreadMap      = {};   // {friendUid: count}

/* ---------------- Drawer toggle ------------------------------------------- */
const drawer  = document.getElementById("drawer");
const overlay = document.getElementById("overlay");
document.getElementById("menuBtn").onclick = () => {
  drawer.classList.toggle("-translate-x-full");
  overlay.classList.toggle("hidden");
};
overlay.onclick = () => {
  drawer.classList.add("-translate-x-full");
  overlay.classList.add("hidden");
};

/* ========================================================================== */
/*  🔔  UNREAD‐COUNT PIPELINE                                                 */
/* ========================================================================== */
function bindUnreadListeners () {
  db.ref('chats').on('child_added', roomSnap => {
    const roomId = roomSnap.key;
    if (!roomId.includes(currentUser.uid)) return;   // skip other people's rooms

    roomSnap.ref.on('value', snap => {
      const friendUid = roomId.split('_').find(id => id !== currentUser.uid);
      let unseen = 0;

      snap.forEach(c => {
        const m = c.val();
        if (m.uid !== currentUser.uid && m.status !== 'seen') unseen++;
      });

      unreadMap[friendUid] = unseen;
      renderUserList();
      updateGlobalUnread();
    });
  });
}

function updateGlobalUnread () {
  const total = Object.values(unreadMap).reduce((a, b) => a + b, 0);
  const badge = document.getElementById('globalUnread');
  if (total > 0) {
    badge.textContent = total > 99 ? '99+' : total;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

/* ========================================================================== */
/*  💬  MESSAGE FLOW                                                          */
/* ========================================================================== */
function listenForMessages () {
  const ref = db.ref(`chats/${currentChatRoom}`);
  ref.off();
  ref.on('child_added', s => displayMessage(s.val()));
}

function displayMessage (msg) {
  const wrap = document.getElementById('messages');
  const me   = msg.uid === currentUser.uid;

  const div  = document.createElement('div');
  div.className = `flex items-end gap-2 ${me ? 'justify-end' : 'justify-start'}`;

  const avatar = `<img src="${msg.avatar || `https://i.pravatar.cc/150?u=${msg.uid}`}"
                       class="w-8 h-8 rounded-full object-cover">`;

  div.innerHTML = me
    ? /* mine */ `
        <div class="flex flex-col items-end max-w-[90%] min-w-[12rem]">
          <div class="bg-black text-white p-3 rounded-2xl shadow w-full">
            <div class="text-sm font-medium">${msg.name}</div>
            <div class="text-sm">${msg.text}</div>
            <div class="text-xs text-gray-300 mt-1 text-right">
              ${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
            </div>
          </div>
        </div>${avatar}`
    : /* theirs */ `
        ${avatar}
        <div class="flex flex-col items-start max-w-[90%] min-w-[12rem]">
          <div class="bg-gray-200 p-3 rounded-2xl shadow w-full">
            <div class="text-sm font-medium">${msg.name}</div>
            <div class="text-sm">${msg.text}</div>
            <div class="text-xs text-gray-400 mt-1 text-right">
              ${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
            </div>
          </div>
        </div>`;

  wrap.appendChild(div);
  wrap.scrollTop = wrap.scrollHeight;
}

/* ========================================================================== */
/*  📋  FRIEND LIST / DRAWER                                                  */
/* ========================================================================== */
function loadOnlineUsers () {
  const userList = document.getElementById('userList');

  db.ref('friends/' + currentUser.uid).once('value').then(fSnap => {
    const friendUIDs = Object.keys(fSnap.val() || {});

    Promise.all(
      friendUIDs.map(uid =>
        db.ref('users/' + uid).once('value').then(u => ({ uid, user: u.val() }))
      )
    ).then(arr => {
      userList.innerHTML = '';   // reset
      arr.forEach(({ uid, user }) => {
        const unseen = unreadMap[uid] || 0;

        const card   = document.createElement('div');
        card.className = 'bg-white rounded-xl p-3 shadow flex gap-3 items-start cursor-pointer hover:bg-gray-100';
        card.onclick   = () => {
          openChatWithUser(uid, user);
          drawer.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
        };

        const avatarUrl =
          user.avatar && user.avatar.trim() !== ''
            ? user.avatar
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=random&color=fff&size=128`;

        card.innerHTML = `
          <img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover" />
          <div class="flex-1 min-w-0">
            <div class="font-semibold truncate">${user.name}</div>
          </div>
          ${
            unseen > 0
              ? `<span class="ml-auto bg-red-600 text-white text-[10px]
                       min-w-[18px] px-1 py-0.5 rounded-full text-center self-start">
                   ${unseen > 99 ? '99+' : unseen}
                 </span>`
              : ''
          }`;

        userList.appendChild(card);
      });
    });
  });
}

function renderUserList () { loadOnlineUsers(); }

/* ========================================================================== */
/*  🚪  ENTER CHAT ROOM  (mark as seen)                                       */
/* ========================================================================== */
function openChatWithUser (uid, user) {
  currentChatRoom = [currentUser.uid, uid].sort().join('_');
  document.getElementById('messages').innerHTML = '';

  /* mark friend’s messages as seen */
  const roomRef = db.ref(`chats/${currentChatRoom}`);
  roomRef.once('value').then(snap => {
    snap.forEach(child => {
      const m = child.val();
      if (m.uid === uid && m.status !== 'seen') {
        child.ref.update({ status: 'seen' });
      }
    });
    unreadMap[uid] = 0;    // local clear
    renderUserList();
    updateGlobalUnread();
  });

  listenForMessages();
}

/* ========================================================================== */
/*  ✉️  SEND MESSAGE                                                          */
/* ========================================================================== */
document.getElementById('messageForm').addEventListener('submit', e => {
  e.preventDefault();
  const input = document.getElementById('messageInput');
  const text  = input.value.trim();
  if (!text) return;

  const msg = {
    uid:        currentUser.uid,
    name:       currentUser.displayName || 'User',
    avatar:     currentUser.photoURL || `https://i.pravatar.cc/150?u=${currentUser.uid}`,
    text,
    timestamp:  Date.now(),
    status:     'delivered'
  };
  db.ref(`chats/${currentChatRoom}`).push(msg);
  input.value = '';
});

/* ========================================================================== */
/*  😊  Emoji picker                                                          */
/* ========================================================================== */
document.addEventListener('DOMContentLoaded', () => {
  const picker = new EmojiButton({ position: 'top-start', theme: 'light' });
  picker.on('emoji', emoji => {
    const inp = document.getElementById('messageInput');
    const s   = inp.selectionStart;
    const t   = inp.selectionEnd;
    inp.value = inp.value.slice(0, s) + emoji + inp.value.slice(t);
    inp.focus();
    inp.selectionStart = inp.selectionEnd = s + emoji.length;
  });
  document.getElementById('emojiButton')
          .addEventListener('click', () => picker.togglePicker(emojiButton));
});

/* ========================================================================== */
/*  👤  AUTH BOOTSTRAP                                                        */
/* ========================================================================== */
auth.onAuthStateChanged(user => {
  if (!user) { window.location.href = 'index.html'; return; }
  currentUser = user;

  db.ref(`users/${user.uid}`).set({
    name:   user.displayName || 'User',
    avatar: user.photoURL     || `https://i.pravatar.cc/150?u=${user.uid}`
  });

  bindUnreadListeners();
  listenForMessages();
  loadOnlineUsers();
});

/* ========================================================================== */
</script>
</body>
</html>
