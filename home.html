<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loopa Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #fafafa;
      color: #262626;
      margin: 0;
      padding-bottom: 70px;
    }
    ::-webkit-scrollbar {
      display: none;
    }

    /* Header */
    header {
      background: #fff;
      border-bottom: 1px solid #dbdbdb;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .logo {
      font-family: 'Lobster', cursive;
      font-size: 24px;
      font-weight: 600;
    }

    /* Drawer */
    #drawer {
      width: 280px;
      max-width: 80%;
      background: #fff;
      border-right: 1px solid #dbdbdb;
      z-index: 40;
    }
    .drawer-link {
      @apply flex items-center gap-3 py-2 px-4 rounded-lg text-base font-medium text-gray-900 hover:bg-gray-100 hover:text-blue-500 transition;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #dbdbdb;
      height: 60px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.1);
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      z-index: 1000;
    }
    .bottom-nav a {
      flex: 1;
      text-align: center;
      color: #262626;
      font-size: 12px;
      padding: 8px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: color 0.3s ease;
    }
    .bottom-nav a svg {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: #262626;
      stroke-width: 2;
      margin-bottom: 2px;
      transition: stroke 0.3s ease, transform 0.3s ease;
    }
    .bottom-nav a.active,
    .bottom-nav a:hover {
      color: #0095f6;
    }
    .bottom-nav a.active svg,
    .bottom-nav a:hover svg {
      stroke: #0095f6;
      transform: scale(1.1);
    }
    .bottom-nav a.active svg {
      animation: pulse 1.5s infinite;
    }
    .bottom-nav .fab {
      background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
      border-radius: 12px;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transform: translateY(-10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      padding: 0;
    }
    .bottom-nav .fab:hover {
      transform: translateY(-12px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    .bottom-nav .fab svg {
      stroke: #fff;
      width: 24px;
      height: 24px;
      margin: 0;
    }
    .badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ff3040;
      color: #fff;
      font-size: 10px;
      min-width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1.1); }
      50% { transform: scale(1.2); }
    }

    /* Reels */
    .reels-container {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .reel-item {
      flex: 0 0 auto;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s ease;
      position: relative; /* Added for reel count badge positioning */
    }
    .reel-item:hover {
      transform: scale(1.05);
    }
    .reel-item .avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(45deg, #f58529, #dd2a7b, #8134af);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .reel-item .avatar div {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid #fff;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 500;
      text-align: center;
      overflow: hidden;
      padding: 4px;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .reel-item p {
      font-size: 12px;
      color: #262626;
      margin-top: 4px;
      max-width: 64px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .reel-count-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: #ff3040;
      color: #fff;
      font-size: 10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #fff;
    }

    /* Posts */
    .post {
      background: #fff;
      border: 1px solid #dbdbdb;
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
    }
    .post-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      gap: 12px;
    }
    .post-content {
      padding: 12px 16px;
      font-size: 14px;
      line-height: 1.5;
    }
    .post-image {
      width: 100%;
      max-height: 500px;
      object-fit: cover;
    }
    .post-actions {
      display: flex;
      gap: 16px;
      padding: 8px 16px;
    }
    .post-actions button {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: #262626;
    }
    .post-actions button svg {
      width: 20px;
      height: 20px;
    }
    .repost-btn.reposted svg {
      stroke: #0095f6;
      fill: #0095f6;
    }

    /* Modals */
    .modal {
      background: rgba(0, 0, 0, 0.6);
    }
    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      width: 90%;
      max-width: 400px;
    }
    .modal textarea,
    .modal input[type="text"] {
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 12px;
    }
    .modal button {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
    }

    /* Reel Viewer Modal */
    .reel-viewer-modal {
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .reel-viewer-content {
      position: relative;
      width: 100%;
      max-width: 500px;
      padding: 16px;
      text-align: center;
    }
    .reel-viewer-text {
      color: #fff;
      font-size: 18px;
      line-height: 1.5;
      word-wrap: break-word;
      padding: 20px;
    }
    .reel-viewer-image {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
      margin-bottom: 20px;
    }
    .reel-viewer-close {
      position: absolute;
      top: 16px;
      right: 16px;
      color: #fff;
      cursor: pointer;
    }
    .reel-nav {
      position: absolute;
      top: 50%;
      width: 100%;
      display: flex;
      justify-content: space-between;
      transform: translateY(-50%);
    }
    .reel-nav button {
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .reel-nav button:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    .reel-nav button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .reel-index {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <button id="burger" class="p-2 focus:outline-none">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
    <h1 class="logo">Loopa</h1>
    <div class="w-6"></div>
  </header>

  <!-- Drawer -->
  <div id="overlay" class="fixed inset-0 bg-black/60 opacity-0 pointer-events-none transition-opacity duration-300 z-30"></div>
  <aside id="drawer" class="fixed inset-y-0 left-0 w-64 max-w-[80%] -translate-x-full bg-white shadow-lg overflow-y-auto transition-transform duration-300 z-40">
    <div class="p-4 space-y-6">
      <div class="text-xl font-bold">Menu</div>
      <div class="flex items-center space-x-3">
        <img src="https://i.pravatar.cc/40" alt="avatar" class="rounded-full w-10 h-10"/>
        <div>
          <p class="font-medium">Hi, There!</p>
          <a href="profile.html" class="text-sm text-blue-500">View profile</a>
        </div>
      </div>
      <nav class="flex flex-col space-y-2">
        <a href="home.html" class="drawer-link">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l9-9 9 9v9a3 3 0 01-3 3h-4v-6H10v6H6a3 3 0 01-3 v-9z"/>
          </svg>
          Home
        </a>
        <a href="ride.html" class="drawer-link">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l6-7m0 0l7 7m-7-7v18"/>
          </svg>
          Get a Ride
        </a>
        <a href="food.html" class="drawer-link">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v18H3V3z"/>
          </svg>
          Order Food
        </a>
        <a href="study.html" class="drawer-link">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
          Study Materials
        </a>
        <a href="chat.html" class="drawer-link">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
          Search For Friends
        </a>
        <a href="requests.html" class="drawer-link">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a4 4 0 00-3-3.87M9 20H4v-2a4 4 0 013-3.87M12 12a4 4 0 100-8 4 4 0 000 8zM16 7a4 4 0 110 8"/>
          </svg>
          Requests
        </a>
        <hr class="border-gray-200"/>
        <a href="settings.html" class="drawer-link">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37 1 .608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
          </svg>
          Settings
        </a>
        <button class="drawer-link text-red-500 text-left">Log out</button>
      </nav>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="max-w-md mx-auto p-4">
    <!-- Reels -->
    <div class="flex items-center justify-between mb-4 px-2">
      <h2 class="text-lg font-semibold">Just Reels</h2>
      <a href="https://www.chatbase.co/chatbot-iframe/WadQfJamkW2Hl2U4NbGbH">
        <button id="ai-button" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-sm px-4 py-1 rounded-full flex items-center gap-2 hover:from-purple-600 hover:to-pink-600 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <rect x="6" y="8" width="12" height="8" rx="2" ry="2"/>
            <circle cx="9" cy="12" r="1" fill="currentColor"/>
            <circle cx="15" cy="12" r="1" fill="currentColor"/>
            <path d="M12 16v2" stroke-linecap="round"/>
          </svg>
          NexoraAI
        </button>
      </a>
    </div>
    <div class="reels-container"></div>

    <!-- Feed -->
    <div id="posts" class="space-y-4"></div>
  </main>

  <!-- Create Modal -->
  <div id="createModal" class="modal fixed inset-0 flex items-center justify-center bg-black/60 z-50 hidden">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-3">Create</h3>
      <button id="createPostOption" class="w-full bg-gray-100 text-gray-800 py-2 rounded-lg mb-2 hover:bg-gray-200 transition">Create Post</button>
      <button id="createReelOption" class="w-full bg-gray-100 text-gray-800 py-2 rounded-lg hover:bg-gray-200 transition">Create Reel</button>
    </div>
  </div>

  <!-- Post Modal -->
  <div id="postInputModal" class="modal fixed inset-0 flex items-center justify-center bg-black/60 z-50 hidden">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-3">Create a Post</h3>
      <textarea id="postInput" placeholder="What's on your mind?" class="mb-4"></textarea>
      <input type="text" id="postImageUrl" placeholder="Image URL (optional)" class="mb-4"/>
      <div class="flex justify-end gap-2">
        <button id="cancelPost" class="bg-gray-200 text-gray-800 rounded-full">Cancel</button>
        <button id="postBtn" class="bg-blue-500 text-white rounded-full">Post</button>
      </div>
    </div>
  </div>

  <!-- Reel Modal -->
  <div id="reelInputModal" class="modal fixed inset-0 flex items-center justify-center bg-black/60 z-50 hidden">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-3">Create a Reel</h3>
      <textarea id="reelText" placeholder="What's on your mind?" maxlength="100" class="mb-4"></textarea>
      <input type="text" id="reelImageUrl" placeholder="Image URL (optional)" class="mb-4"/>
      <div class="flex justify-end gap-2">
        <button id="cancelReel" class="bg-gray-200 text-gray-800 rounded-full">Cancel</button>
        <button id="postReel" class="bg-blue-500 text-white rounded-full">Post</button>
      </div>
    </div>
  </div>

  <!-- Reel Viewer Modal -->
  <div id="reelViewerModal" class="reel-viewer-modal fixed inset-0 z-50 hidden">
    <div class="reel-viewer-content">
      <div id="reelViewerImage" class="reel-viewer-image"></div>
      <div id="reelViewerText" class="reel-viewer-text"></div>
      <button id="closeReelViewer" class="reel-viewer-close" aria-label="Close reel viewer">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <!-- Added navigation for multiple reels -->
      <div class="reel-nav">
        <button id="prevReel" aria-label="Previous reel">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <button id="nextReel" aria-label="Next reel">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
      </div>
      <div id="reelIndex" class="reel-index" aria-live="polite"></div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Bottom Navigation">
    <a href="#home" class="active" aria-current="page">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l9-9 9 9v9a3 3 0 01-3 3h-4v-6H10v6H6a3 3 0 01-3-3v-9z"/>
      </svg>
      Home
      <span id="postCountBadge" class="badge hidden"></span>
    </a>
    <a href="chat.html">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a4 4 0 014-4h6a4 4 0 014 4v2h-4"/>
      </svg>
      Chat
    </a>
    <a href="#create" class="fab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
    </a>
    <a href="requests.html">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a4 4 0 00-3-3.87M9 20H4v-2a4 4 0 013-3.87M12 12a4 4 0 100-8 4 4 0 000 8zM16 7a4 4 0 110 8"/>
      </svg>
      Requests
    </a>
    <a href="profile.html">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4 0-7 2-7 4v2h14v-2c0-2-3-4-7-4z"/>
      </svg>
      Profile
    </a>
  </nav>

  <!-- Scripts -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (!user) return window.location.href = "index.html";
      currentUser = user;
      loadPosts();
      loadReels();
    });

    // Drawer
    const burger = document.getElementById('burger');
    const overlay = document.getElementById('overlay');
    const drawer = document.getElementById('drawer');

    function openDrawer() {
      drawer.classList.remove('-translate-x-full');
      overlay.classList.remove('opacity-0', 'pointer-events-none');
    }
    function closeDrawer() {
      drawer.classList.add('-translate-x-full');
      overlay.classList.add('opacity-0', 'pointer-events-none');
    }
    burger.addEventListener('click', openDrawer);
    overlay.addEventListener('click', closeDrawer);
    drawer.querySelectorAll('.drawer-link').forEach(link => {
      link.addEventListener('click', closeDrawer);
    });

    // Create Modal
    const createModal = document.getElementById('createModal');
    const createPostOption = document.getElementById('createPostOption');
    const createReelOption = document.getElementById('createReelOption');
    document.querySelector('.bottom-nav .fab').addEventListener('click', () => {
      createModal.classList.remove('hidden');
    });
    createPostOption.addEventListener('click', () => {
      createModal.classList.add('hidden');
      document.getElementById('postInputModal').classList.remove('hidden');
    });
    createReelOption.addEventListener('click', () => {
      createModal.classList.add('hidden');
      document.getElementById('reelInputModal').classList.remove('hidden');
    });

    // Post Modal
    const postInputModal = document.getElementById('postInputModal');
    const postInput = document.getElementById('postInput');
    const postImageUrl = document.getElementById('postImageUrl');
    const postBtn = document.getElementById('postBtn');
    const cancelPost = document.getElementById('cancelPost');

    cancelPost.addEventListener('click', () => {
      postInputModal.classList.add('hidden');
      postInput.value = '';
      postImageUrl.value = '';
    });

    postBtn.addEventListener('click', () => {
      const content = postInput.value.trim();
      const imageUrl = postImageUrl.value.trim();
      if (!content) return alert('Post content cannot be empty.');

      const postRef = db.ref('posts').push();
      const postData = {
        uid: currentUser.uid,
        name: currentUser.displayName || 'Anonymous',
        email: currentUser.email,
        avatar: currentUser.photoURL || `https://i.pravatar.cc/150?u=${currentUser.uid}`,
        content,
        timestamp: Date.now()
      };
      if (imageUrl) postData.imageUrl = imageUrl;

      postRef.set(postData);
      postInputModal.classList.add('hidden');
      postInput.value = '';
      postImageUrl.value = '';
    });

    // Reel Modal
    const reelModal = document.getElementById('reelInputModal');
    const cancelReel = document.getElementById('cancelReel');
    const postReel = document.getElementById('postReel');
    const reelTextInput = document.getElementById('reelText');
    const reelImageUrl = document.getElementById('reelImageUrl');

    cancelReel.addEventListener('click', () => {
      reelModal.classList.add('hidden');
      reelTextInput.value = '';
      reelImageUrl.value = '';
    });

    postReel.addEventListener('click', () => {
      const text = reelTextInput.value.trim();
      const imageUrl = reelImageUrl.value.trim();
      if (!text) return alert('Reel content cannot be empty.');

      const user = firebase.auth().currentUser;
      if (!user) return alert('Please log in to post a reel.');

      const reelData = {
        name: user.displayName || 'Anonymous',
        uid: user.uid,
        text,
        timestamp: Date.now()
      };
      if (imageUrl) reelData.imageUrl = imageUrl;

      firebase.database().ref('reels').push(reelData).then(() => {
        reelModal.classList.add('hidden');
        reelTextInput.value = '';
        reelImageUrl.value = '';
      });
    });

    // Reel Viewer Modal
    const reelViewerModal = document.getElementById('reelViewerModal');
    const reelViewerText = document.getElementById('reelViewerText');
    const reelViewerImage = document.getElementById('reelViewerImage');
    const closeReelViewer = document.getElementById('closeReelViewer');
    const prevReelBtn = document.getElementById('prevReel');
    const nextReelBtn = document.getElementById('nextReel');
    const reelIndexEl = document.getElementById('reelIndex');

    let currentReels = []; // Store the current user's reels
    let currentReelIndex = 0; // Track the current reel index

    closeReelViewer.addEventListener('click', () => {
      reelViewerModal.classList.add('hidden');
      reelViewerImage.style.display = 'none';
      reelViewerImage.src = '';
      currentReels = [];
      currentReelIndex = 0;
    });

    function showReel(index) {
      const reel = currentReels[index];
      reelViewerText.textContent = reel.text;
      if (reel.imageUrl) {
        reelViewerImage.src = reel.imageUrl;
        reelViewerImage.style.display = 'block';
      } else {
        reelViewerImage.style.display = 'none';
        reelViewerImage.src = '';
      }
      reelIndexEl.textContent = `${index + 1}/${currentReels.length}`;
      prevReelBtn.disabled = index === 0;
      nextReelBtn.disabled = index === currentReels.length - 1;
    }

    prevReelBtn.addEventListener('click', () => {
      if (currentReelIndex > 0) {
        currentReelIndex--;
        showReel(currentReelIndex);
      }
    });

    nextReelBtn.addEventListener('click', () => {
      if (currentReelIndex < currentReels.length - 1) {
        currentReelIndex++;
        showReel(currentReelIndex);
      }
    });

    function loadReels() {
      const reelsContainer = document.querySelector('.reels-container');
      const now = Date.now();

      firebase.database().ref('reels').on('value', snapshot => {
        reelsContainer.innerHTML = '';
        const reels = snapshot.val() || {};

        // Group reels by user
        const userReels = {};
        Object.entries(reels).forEach(([id, reel]) => {
          const age = now - reel.timestamp;
          if (age > 86400000) {
            firebase.database().ref(`reels/${id}`).remove();
          } else {
            if (!userReels[reel.uid]) {
              userReels[reel.uid] = { name: reel.name, reels: [] };
            }
            userReels[reel.uid].reels.push({ id, ...reel });
          }
        });

        // Render one reel item per user
        Object.entries(userReels).forEach(([uid, { name, reels }]) => {
          // Sort reels by timestamp (newest first)
          reels.sort((a, b) => b.timestamp - a.timestamp);
          const latestReel = reels[0]; // Show the most recent reel in the avatar

          const reelEl = document.createElement('div');
          reelEl.className = 'reel-item';
          reelEl.innerHTML = `
            <div class="avatar">
              <div>${latestReel.text.length > 30 ? latestReel.text.slice(0, 28) + 'â€¦' : latestReel.text}</div>
            </div>
            <p>${name}</p>
            ${reels.length > 1 ? `<span class="reel-count-badge" aria-label="${reels.length} reels">${reels.length}</span>` : ''}
          `;
          reelEl.addEventListener('click', () => {
            currentReels = reels;
            currentReelIndex = 0;
            showReel(currentReelIndex);
            reelViewerModal.classList.remove('hidden');
          });
          reelsContainer.appendChild(reelEl);
        });
      });
    }

    function formatTimestamp(timestamp) {
      const now = new Date();
      const postDate = new Date(timestamp);
      const diffMs = now - postDate;
      const diffMinutes = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMinutes < 1) return 'Just now';
      if (diffMinutes < 60) return `${diffMinutes} min${diffMinutes > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      if (diffDays === 1) return `Yesterday at ${postDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

      return postDate.toLocaleDateString(undefined, {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    async function loadPosts() {
      db.ref('posts').on('value', async snapshot => {
        const posts = snapshot.val() || {};
        const postsContainer = document.getElementById('posts');
        postsContainer.innerHTML = '';

        for (const [postId, post] of Object.entries(posts).reverse()) {
          let originalPost = {};
          if (post.originalPostId) {
            const originalSnapshot = await db.ref(`posts/${post.originalPostId}`).once('value');
            originalPost = originalSnapshot.val() || {};
          }

          const isOwnPost = post.uid === currentUser.uid;
          const postEl = document.createElement('div');
          postEl.className = 'post';
          postEl.innerHTML = `
            <div class="post-header">
              <img src="${post.avatar}" class="w-8 h-8 rounded-full"/>
              <div class="flex-1">
                <p class="font-semibold text-sm">${post.name}${post.originalPostId ? ` (Reposted from ${originalPost.name || 'someone'})` : ''}</p>
                <span class="text-xs text-gray-500">${formatTimestamp(post.timestamp)}</span>
              </div>
              ${isOwnPost ? `
                <div class="flex gap-2">
                  <button class="edit-post-btn text-gray-500 p-1" data-id="${postId}" title="Edit">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11.5A1.5 1.5 0 005.5 20H17a2 2 0 002-2v-5M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                  </button>
                  <button class="delete-post-btn text-gray-500 p-1" data-id="${postId}" title="Delete">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>` : `
                <button class="follow-btn bg-blue-500 text-white text-xs px-3 py-1 rounded-full hidden" data-user="${post.uid}">Follow</button>`}
            </div>
            ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" alt="Post image"/>` : ''}
            <div class="post-content" id="content-${postId}">${post.content}</div>
            <div class="post-actions">
              <button class="like-btn" data-id="${postId}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                <span id="like-count-${postId}" class="text-sm">0</span>
              </button>
              <button class="comment-btn" data-id="${postId}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
              </button>
              <button class="repost-btn" data-id="${postId}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                </svg>
                <span id="repost-count-${postId}" class="text-sm">0</span>
              </button>
            </div>
            <div id="comments-${postId}" class="px-4 py-2 space-y-2"></div>
            <div class="px-4 py-2 border-t border-gray-200">
              <div class="flex items-center gap-2">
                <input type="text" placeholder="Write a comment..." class="comment-input flex-1 border-0 bg-gray-100 rounded-full px-4 py-2 text-sm focus:ring-0" data-id="${postId}"/>
                <button class="comment-btn bg-blue-500 text-white p-2 rounded-full" data-id="${postId}" title="Post Comment">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10l9-6 9 6-9 6-9-6z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 21V9l3-2 3 2v12"/>
                  </svg>
                </button>
              </div>
            </div>
          `;

          postsContainer.appendChild(postEl);

          if (!isOwnPost) {
            const followBtn = postEl.querySelector('.follow-btn');
            const followRef = db.ref(`follows/${currentUser.uid}/${post.uid}`);
            followRef.once('value', snap => {
              if (!snap.exists()) {
                followBtn.classList.remove('hidden');
              }
            });
            followBtn?.addEventListener('click', () => {
              db.ref(`follows/${currentUser.uid}/${post.uid}`).set(true);
              followBtn.classList.add('hidden');
              alert(`You followed ${post.name}`);
            });
          }

          // Like count
          db.ref(`likes/${postId}`).on('value', snap => {
            const likes = snap.val() || {};
            document.getElementById(`like-count-${postId}`).textContent = Object.keys(likes).length;
          });

          // Repost count and state
          db.ref(`reposts/${postId}`).on('value', snap => {
            const reposts = snap.val() || {};
            document.getElementById(`repost-count-${postId}`).textContent = Object.keys(reposts).length;
          });
          db.ref(`reposts/${postId}/${currentUser.uid}`).once('value', snap => {
            if (snap.exists()) {
              postEl.querySelector('.repost-btn').classList.add('reposted');
            }
          });

          postEl.querySelector('.like-btn').addEventListener('click', () => {
            const likeRef = db.ref(`likes/${postId}/${currentUser.uid}`);
            likeRef.once('value', snap => {
              if (snap.exists()) likeRef.remove();
              else likeRef.set(true);
            });
          });

          postEl.querySelector('.comment-btn').addEventListener('click', () => {
            const input = postEl.querySelector(`.comment-input[data-id="${postId}"]`);
            const text = input.value.trim();
            if (!text) return;
            db.ref(`comments/${postId}`).push({
              uid: currentUser.uid,
              name: currentUser.displayName || 'User',
              avatar: currentUser.photoURL || `https://i.pravatar.cc/150?u=${currentUser.uid}`,
              text,
              timestamp: Date.now()
            });
            input.value = '';
          });

          const deleteBtn = postEl.querySelector('.delete-post-btn');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
              if (confirm('Delete this post?')) {
                db.ref(`posts/${postId}`).remove();
                db.ref(`likes/${postId}`).remove();
                db.ref(`comments/${postId}`).remove();
                db.ref(`reposts/${postId}`).remove();
              }
            });
          }

          const editBtn = postEl.querySelector('.edit-post-btn');
          if (editBtn) {
            editBtn.addEventListener('click', () => {
              const newContent = prompt('Edit your post:', post.content);
              const newImageUrl = prompt('Edit image URL (optional, leave blank to remove):', post.imageUrl || '');
              if (newContent && newContent !== post.content) {
                const updates = { content: newContent };
                if (newImageUrl) updates.imageUrl = newImageUrl;
                else if (post.imageUrl) updates.imageUrl = null;
                db.ref(`posts/${postId}`).update(updates);
              }
            });
          }

          loadComments(postId);
        }
      });
    }

    function loadComments(postId) {
      const container = document.getElementById(`comments-${postId}`);
      db.ref(`comments/${postId}`).on('value', snapshot => {
        const comments = snapshot.val() || {};
        container.innerHTML = '';

        Object.entries(comments).forEach(([key, cmt]) => {
          const commentEl = document.createElement('div');
          commentEl.className = 'flex items-start gap-2';
          commentEl.innerHTML = `
            <img src="${cmt.avatar}" class="w-6 h-6 rounded-full mt-1"/>
            <div class="bg-gray-100 px-3 py-2 rounded-xl w-full">
              <div class="flex justify-between items-center mb-1">
                <span class="font-medium text-xs">${cmt.name}</span>
                ${cmt.uid === currentUser.uid ? `<button class="delete-comment text-red-500 text-xs" data-id="${key}">Delete</button>` : ''}
              </div>
              <p class="text-xs">${cmt.text}</p>
              <p class="text-[10px] text-gray-500 mt-1">${new Date(cmt.timestamp).toLocaleTimeString()}</p>
            </div>
          `;
          container.appendChild(commentEl);

          const delBtn = commentEl.querySelector('.delete-comment');
          if (delBtn) {
            delBtn.addEventListener('click', () => {
              db.ref(`comments/${postId}/${key}`).remove();
            });
          }
        });
      });
    }

    // Repost Event Listener (using event delegation)
    document.getElementById('posts').addEventListener('click', async (event) => {
      if (event.target.closest('.repost-btn')) {
        const button = event.target.closest('.repost-btn');
        const postId = button.getAttribute('data-id');
        const postRef = db.ref('posts/' + postId);
        const repostRef = db.ref(`reposts/${postId}/${auth.currentUser?.uid}`);

        try {
          // Check if user has already reposted
          const repostSnapshot = await repostRef.once('value');
          if (repostSnapshot.exists()) {
            alert('You have already reposted this post.');
            return;
          }

          const snapshot = await postRef.once('value');
          if (!snapshot.exists()) {
            alert('Post not found.');
            return;
          }

          const originalPost = snapshot.val();
          const currentUser = auth.currentUser;

          if (!currentUser) {
            alert('Please log in to repost.');
            return;
          }

          const newPost = {
            content: originalPost.content,
            uid: currentUser.uid,
            name: currentUser.displayName || 'Anonymous',
            avatar: currentUser.photoURL || `https://i.pravatar.cc/150?u=${currentUser.uid}`,
            originalPostId: postId,
            timestamp: Date.now()
          };
          if (originalPost.imageUrl) newPost.imageUrl = originalPost.imageUrl;

          await db.ref('posts').push(newPost);
          await repostRef.set(true); // Track the repost
          button.classList.add('reposted');
          alert('Reposted!');
        } catch (err) {
          console.error('Repost error:', err);
          alert('Failed to repost. Please try again.');
        }
      }
    });

    // Post Counter
    function bindPostCounter() {
      const badge = document.getElementById('postCountBadge');
      db.ref('posts').on('value', snap => {
        const count = snap.numChildren();
        if (count === 0) {
          badge.classList.add('hidden');
        } else {
          badge.textContent = count > 99 ? '99+' : count;
          badge.classList.remove('hidden');
        }
      });
    }
    bindPostCounter();
  </script>
</body>
</html>
